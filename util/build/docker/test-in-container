#!/usr/bin/env bash
# test-in-container -- Tests inside a Docker container with the latest build
##
set -euo pipefail
. "$(dirname "$0")"/config.bash

# NOTE other containers, e.g., postgresql or gpdb, can be run externally, then
# their names can be passed as arguments for --link options followed by the
# normal test command, e.g.:
# $ test-in-container --link test-pg --link test-gp netj/deepdive-build make test

# default test command
[[ $# -gt 0 ]] || set -- \
    $(! [[ -t 1 ]] || echo --tty --interactive) \
    "$DOCKER_IMAGE" \
    make test

DOCKER_CONTAINER+="-test.$$"

# run tests
trap 'docker rm -f "$DOCKER_CONTAINER"' EXIT
set -x
DOCKER_IMAGE_TEST=$DOCKER_IMAGE_TEST_PREFIX
if docker run \
    --name "$DOCKER_CONTAINER" \
    "$@"
then exit_status=$? DOCKER_IMAGE_TEST+="PASS"
else exit_status=$? DOCKER_IMAGE_TEST+="FAIL"
fi
# commit test result
docker commit "$DOCKER_CONTAINER" "$DOCKER_IMAGE_TEST"
exit $exit_status
