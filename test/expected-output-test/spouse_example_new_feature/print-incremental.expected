articles(article_id text,
         text text).

dd_delta_articles(article_id text,
                  text text).

dd_new_articles(article_id text,
                text text).

dd_new_articles(article_id, text) :-
    articles(article_id, text);
    dd_delta_articles(article_id, text).

sentences(document_id text,
          sentence text,
          words text[],
          lemma text[],
          pos_tags text[],
          dependencies text[],
          ner_tags text[],
          sentence_offset int,
          sentence_id text).

dd_delta_sentences(document_id text,
                   sentence text,
                   words text[],
                   lemma text[],
                   pos_tags text[],
                   dependencies text[],
                   ner_tags text[],
                   sentence_offset int,
                   sentence_id text).

dd_new_sentences(document_id text,
                 sentence text,
                 words text[],
                 lemma text[],
                 pos_tags text[],
                 dependencies text[],
                 ner_tags text[],
                 sentence_offset int,
                 sentence_id text).

dd_new_sentences(document_id, sentence, words, lemma, pos_tags, dependencies, ner_tags, sentence_offset, sentence_id) :-
    sentences(document_id, sentence, words, lemma, pos_tags, dependencies, ner_tags, sentence_offset, sentence_id);
    dd_delta_sentences(document_id, sentence, words, lemma, pos_tags, dependencies, ner_tags, sentence_offset, sentence_id).

people_mentions(sentence_id text,
                start_position int,
                length int,
                text text,
                mention_id text).

dd_delta_people_mentions(sentence_id text,
                         start_position int,
                         length int,
                         text text,
                         mention_id text).

dd_new_people_mentions(sentence_id text,
                       start_position int,
                       length int,
                       text text,
                       mention_id text).

dd_new_people_mentions(sentence_id, start_position, length, text, mention_id) :-
    people_mentions(sentence_id, start_position, length, text, mention_id);
    dd_delta_people_mentions(sentence_id, start_position, length, text, mention_id).

has_spouse_candidates(person1_id text,
                      person2_id text,
                      sentence_id text,
                      description text,
                      relation_id text,
                      is_true boolean).

dd_delta_has_spouse_candidates(person1_id text,
                               person2_id text,
                               sentence_id text,
                               description text,
                               relation_id text,
                               is_true boolean).

dd_new_has_spouse_candidates(person1_id text,
                             person2_id text,
                             sentence_id text,
                             description text,
                             relation_id text,
                             is_true boolean).

dd_new_has_spouse_candidates(person1_id, person2_id, sentence_id, description, relation_id, is_true) :-
    has_spouse_candidates(person1_id, person2_id, sentence_id, description, relation_id, is_true);
    dd_delta_has_spouse_candidates(person1_id, person2_id, sentence_id, description, relation_id, is_true).

has_spouse_features(relation_id text,
                    feature text).

dd_delta_has_spouse_features(relation_id text,
                             feature text).

dd_new_has_spouse_features(relation_id text,
                           feature text).

dd_new_has_spouse_features(relation_id, feature) :-
    has_spouse_features(relation_id, feature);
    dd_delta_has_spouse_features(relation_id, feature).

has_spouse?(relation_id text).

dd_delta_has_spouse?(relation_id text).

dd_new_has_spouse?(relation_id text).

dd_new_has_spouse(relation_id) :-
    has_spouse(relation_id);
    dd_delta_has_spouse(relation_id).

function ext_people
    over (sentence_id text, words text, ner_tags text)
 returns rows like dd_delta_people_mentions
 implementation "udf/ext_people.py"
        handles tsv lines.

dd_delta_people_mentions += ext_people(s, ARRAY_TO_STRING(words, "~^~"), ARRAY_TO_STRING(ner_tags, "~^~")) :-
    dd_delta_sentences(_, _, words, _, _, _, ner_tags, _, s).

function ext_has_spouse
    over (sentence_id text, mid1 text, text1 text, mid2 text, text2 text)
 returns rows like dd_delta_has_spouse_candidates
 implementation "udf/ext_has_spouse.py"
        handles tsv lines.

dd_delta_has_spouse_candidates += ext_has_spouse(s, p1_id, p1_text, p2_id, p2_text) :-
    dd_delta_people_mentions(s, _, _, p1_text, p1_id),
    people_mentions(s, _, _, p2_text, p2_id);
    dd_new_people_mentions(s, _, _, p1_text, p1_id),
    dd_delta_people_mentions(s, _, _, p2_text, p2_id).

function ext_has_spouse_features
    over (words text, rid text, position1 int, length1 int, position2 int, length2 int)
 returns rows like dd_delta_has_spouse_features
 implementation "udf/ext_has_spouse_features.py"
        handles tsv lines.

dd_delta_has_spouse_features += ext_has_spouse_features(ARRAY_TO_STRING(words, "~^~"), rid, p1idx, p1len, p2idx, p2len) :-
    sentences(_, _, words, _, _, _, _, _, s),
    has_spouse_candidates(person1_id, person2_id, s, _, rid, _),
    people_mentions(s, p1idx, p1len, _, person1_id),
    people_mentions(s, p2idx, p2len, _, person2_id);
    dd_delta_sentences(_, _, words, _, _, _, _, _, s),
    has_spouse_candidates(person1_id, person2_id, s, _, rid, _),
    people_mentions(s, p1idx, p1len, _, person1_id),
    people_mentions(s, p2idx, p2len, _, person2_id);
    dd_new_sentences(_, _, words, _, _, _, _, _, s),
    dd_delta_has_spouse_candidates(person1_id, person2_id, s, _, rid, _),
    people_mentions(s, p1idx, p1len, _, person1_id),
    people_mentions(s, p2idx, p2len, _, person2_id);
    dd_new_sentences(_, _, words, _, _, _, _, _, s),
    dd_new_has_spouse_candidates(person1_id, person2_id, s, _, rid, _),
    dd_delta_people_mentions(s, p1idx, p1len, _, person1_id),
    people_mentions(s, p2idx, p2len, _, person2_id);
    dd_new_sentences(_, _, words, _, _, _, _, _, s),
    dd_new_has_spouse_candidates(person1_id, person2_id, s, _, rid, _),
    dd_new_people_mentions(s, p1idx, p1len, _, person1_id),
    dd_delta_people_mentions(s, p2idx, p2len, _, person2_id).

@label(l)
dd_delta_has_spouse(rid) :-
    dd_delta_has_spouse_candidates(_, _, _, _, rid, l).

@weight(f)
dd_new_has_spouse(rid) :-
    dd_delta_has_spouse_candidates(_, _, _, _, rid, _),
    has_spouse_features(rid, f);
    dd_new_has_spouse_candidates(_, _, _, _, rid, _),
    dd_delta_has_spouse_features(rid, f).

